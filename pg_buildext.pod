=head1 NAME

pg_buildext - Build and install a PostgreSQL extension

=head1 SYNOPSIS

B<pg_buildext> I<action> [I<options>]

=head1 DESCRIPTION

B<pg_buildext> is a script that will build a PostgreSQL extension in a C<VPATH>
way, for potentially several PostgreSQL server versions in parallel.
It builds for the intersection of versions known in
C<debian/pgversions> (versions supported by the package) and in
C</usr/share/postgresql-common/supported-versions> (versions supported in this
release).

=head1 ACTIONS

Most actions expect a directory name where to build the sources. It will get
created for you if it does not exist. If the I<build-dir> contains a C<%v>
sign, it will get replaced by the specific version of PostgreSQL being built
against. (Usually this parameter is C<build-%v>.)

=over 4

=item B<supported-versions>

Print effective list of supported versions, i.e. the intersection of the sets
of versions supported by the system and the package.

=item B<configure> I<build-dir> [I<extra-configure-options>]

For every supported version, call B<../configure> from the I<build-dir>
directory. (Most PostgreSQL extensions do not have a configure script.)

=item B<build> I<build-dir> [I<extra-cflags>]

Build the extension in the I<build-dir> directory.

=item B<install> I<build-dir> I<package-pattern>

Invoke B<make install> from the I<build-dir> directory.
The third parameter specifies the package name to use. Most packages
use B<postgresql-%v-pkgname>. Make will be
called with DESTDIR="$(CURDIR)/debian/I<package>".

=item B<clean> I<build-dir>

Clean the build directory.

=item B<loop> I<package-pattern>

As a variant to calling B<build> and B<install> separately for VPATH builds,
loop over the supported PostgreSQL versions in the top source directory. This
should be used if the package does not support VPATH builds. As it also invokes
B<make install>, it should be placed were installation happens in debian/rules,
rather than where build would normally be called.

=item B<installcheck> [I<build-dir>]

Use B<pg_virtualenv make installcheck> to run the extension regression tests.
This is meant to be run from C<debian/tests/control> using B<autopkgtest>. If
I<build-dir> is omitted, the top source directory is used.

=back

=head1 SUPPORTED VERSIONS

B<pg_buildext> reads C<debian/pgversions> to decide which PostgreSQL to build
modules/extensions for. This file contains one PostgreSQL version number per
line, in the following formats:

=over 4

=item B<all>

Support all versions. This is recommended unless there are known incompatibilities.

=item I<X.Y>

Support this version.

=item I<X.Y>B<+>

Support this and all greater versions.

=item B<#>I<...>

Comment.

=back

For a version to be used, it must also be listed in the output of
C</usr/share/postgresql-common/supported-versions>. See this file for how to
configure the list of supported versions on your system.

=head1 USAGE

As B<pg_buildext> invokes B<make> for the B<build>, B<install>, and B<clean>
actions, invocations from C<debian/rules> (which is a makefile) should be prefixed
with B<+> so the sub-makes can talk with the make jobserver.

=head1 EXAMPLE

  override_dh_auto_configure:
	  +pg_buildext configure build-%v "--libdir=/usr/lib/postgresql/%v/lib --datadir=/usr/share/postgresql-%v-plsh"

  override_dh_auto_build:
	  +pg_buildext build build-%v

  override_dh_auto_test:
	  # nothing to do here, see debian/tests/* instead

  override_dh_auto_install:
	  +pg_buildext install build-%v postgresql-%v-plsh

  override_dh_installdocs:
	  dh_installdocs --all README.*

  override_dh_auto_clean:
	  +pg_buildext clean build-%v

=head1 COMPATIBILITY

Earlier B<pg_buildext> versions required a "source dir" argument after the
action. This is now deprecated, but still accepted (and ignored).

B<pg_buildext loop> was introduced in postgresql-server-dev-all (>= 141~).

The usage of "all" or "X.Y+" in debian/pgversions was introduced in
postgresql-server-dev-all (>= 148~).

B<pg_buildext installcheck> was introduced in postgresql-server-dev-all (>=
153~).

=head1 SEE ALSO

C</usr/share/postgresql-common/supported-versions>, autopkgtest(1),
pg_virtualenv(1).

=head1 AUTHORS

Dimitri Fontaine L<E<lt>dim@tapoueh.orgE<gt>>, with extensions by
Christoph Berg L<E<lt>myon@debian.orgE<gt>>.
