 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="author" content="Oliver Elphick, Martin Pitt">
<title>PostgreSQL client wrapper</title>
</head>
<body>

<h1>Multi-Version/Multi-Cluster PostgreSQL architecture</h1>


<h2>Solving a problem</h2>

<p>
When a new major version of PostgreSQL is released, it is necessary to
dump and reload the database.  The old software must be used for the dump,
and the new software for the reload.</p>

<p>This was a major problem for Red Hat and Debian, because a dump and reload was
not required by every upgrade and by the time the need for a dump is
realised, the old software might have been deleted.  Debian had certain rather
unreliable procedures to save the old software and use it to do a dump, but
these procedures often went wrong.  Red Hat's installation environment is so
rigid that it is not practicable for the Red Hat packages to attempt an
automatic upgrade.  Debian offered a debconf choice for
whether to attempt automatic upgrading; if it failed or was not allowed, a 
manual upgrade had to be done, either from a pre-existing dump or by
manual invocation of the postgresql-dump script.</p>

<p>There was once an upstream program called <b>pg_upgrade</b> which could be
used for in-place upgrading.  This does not currently work and does not seem to
be a high priority with upstream developers.  </p>

<p>It is possible to run different versions of PostgreSQL simultaneously, and
indeed to run the same version on separate database clusters simultaneously.
To do so, each postmaster must listen on a different port, so each client
must specify the correct port.  By having two separate
versions of the PostgreSQL packages installed simultaneously, it is
simple to do database upgrades by dumping from the old version and
uploading to the new.  The PostgreSQL client wrapper is designed to 
permit this.</p>

<h2>General Architecture idea</h2>

<p>The Debian packaging has been changed to create a new package for each major
version.  The criterion for creating a new package is that initdb is required
when upgrading from the previous version. Thus, there are now source packages
<code>postgresql-7.4 and postgresql-8.0 (and similarly for all the binary
packages).</p>

<p>The legacy postgresql and the other existing binary package names have
become dummy packages depending on one of the versioned equivalents. Their only
purpose is now to ensure a smooth upgrade and to register the existing database
cluster to the new architecture. These packages will be removed from the
archive as soon as the next Debian release after Sarge (Etch) is released.</p>

<p>Each versioned package installs into
<code>/usr/lib/postgresql/<i>version</i></code>.  In order to allow users
easily to select the right version and cluster when working, the
<code>postgresql-common</code> package provides the <b>pg_wrapper</b> program,
which reads the per-user and system wide configuration file and forks the
correct executable with the correct library versions according to those
preferences.  <code>/usr/bin</code> provides executables soft-linked to
pg_wrapper.</p>

<p>This architecture also allows separate database clusters to be maintained
for the use of different groups of users; these clusters need not all be of the
same major version.  This allows much greater flexibility for those people
who need to make application software changes consequent on a PostgreSQL
upgrade.</p>

<h2>Detailed structure</h2>

<h3>Configuration hierarchy</h3>

<table cellpadding="6" cellspacing="0" border="0">
<tr><td><code>/etc/default/postgresql-common</code></td> <td>Default values for
all versions (replaces the old <code>postmaster.conf</code> and
<code>postgresql.env</code> in <code>/etc/postgresql</code>)</td></tr>

<tr><td><code>/etc/default/postgresql-<i>version</i></code></td>
<td>Version-specific default values (if not present,
<code>/etc/default/postgresql-common</code> provides fallback values)</td></tr>

<tr><td><code>/etc/postgresql-common/user_clusters</code></td> <td>maps users
against clusters and default databases</td></tr>

<tr><td><code>$HOME/.postgresqlrc</code></td> <td>per-user preferences for
default version/cluster and database; overrides
<code>/etc/postgresql-common/user_clusters</code></td></tr>

<tr>
  <td><code>/etc/postgresql/<i>version</i>/<i>clustername</i></code></td>
  <td>Cluster-specific configuration files: <code>postgresql.conf</code>,
  <code>pg_hba.conf</code>, <code>pg_ident.conf</code>, and a symbolic link
  <code>pgdata</code> which points to the actual data directory</td>
</tr>
</table>

<h3>Per-version files and programs</h3>

<table cellpadding="6" cellspacing="0" border="0">
<tr><td><code>/usr/lib/postgresql/<i>version</i></code></td>		<td colspan="0" rowspan="3" valign="middle">files for a specific version</td></tr>
<tr><td><code>/usr/share/postgresql/<i>version</i></code></td></tr>
<tr><td><code>/usr/share/doc/postgresql/<i>version</i></code></td></tr>
</table>

<h3>Common programs</h3>
<table cellpadding="6" cellspacing="0" border="0">
<tr><td><code>/usr/bin/pg_wrapper</code></td> <td>environment chooser and program selector</td></tr>
<tr><td><code>/usr/bin/<i>program</i></code></td>  <td>symbolic links to pg_wrapper, for all client programs</td></tr>
<tr><td><code>/usr/bin/pg_lsclusters</code></td> <td>list all available clusters with their status and configuration</td></tr>
<tr><td><code>/usr/sbin/pg_createcluster</code></td><td>wrapper for <code>initdb</code>, sets up the necessary configuration structure</td></tr>
<tr><td><code>/usr/sbin/pg_startcluster</code></td><td>wrapper for <code>pg_ctl start</code>, start a cluster</td></tr>
<tr><td><code>/usr/sbin/pg_stopcluster</code></td><td>wrapper for <code>pg_ctl stop</code>, stop a cluster</td></tr>
<tr><td><code>/usr/sbin/pg_reloadcluster</code></td><td>wrapper for <code>pg_ctl reload</code>, reload a cluster</td></tr>
</table>

<h3>psql</h3>

<p>We have abandoned the old non-standard error abort if a connection database
is not specified; psql is not expected to be run directly and all
connection parameters should be provided by pg_wrapper as specified above. In
addition, if no explicit default database is specified in
<code>user_clusters</code>, the default database will correspond to the user
name, thus reintroducing the default upstream behaviour.</p>

<!--
<h3>pg_wrapper</h3>

<p>pg_wrapper has been completely rewritten.  When called a pg_default, it 
allows a user to display his own connection choices, or to change them for
the current session, or for all sessions (by writing <code>~/.postgresqlrc</code>).
When called by root, it  allows user_clusters to be changed.
</p>
<p>When called as pg_exec, pg_wrapper can execute code from an
arbitrary version in order to connect to a remote machine.</p>

<p>When called as a link to any other name, that name is treated as a
client program and a path to the appropriate version of that program is
constructed and executed.</p>

<p>See the man pages for full details of the program's operation.</p>
-->

<h3>/etc/init.d/postgresql-<i>version</i></h3>

<p>This script now handles the postmaster server processes for each
cluster. However, most of the actual work is done by some new administrator
scripts which do per-cluster operations, in particular
<code>pg_startcluster</code>, <code>pg_stopcluster</code>, and
<code>pg_reloadcluster</code>.

<h3>pg_version_upgrade</h3>

<p>This new program replaces postgresql-dump (a Debian specific program).</p>

<p>It is used to migrate a cluster from one major version to another.</p>

<p>Options:
<dl>
<dt>-c <i>cluster</i></dt>
	<dd>the name of the cluster</dd>

<dt>-v <i>version</i></dt>         <dd> the version to upgrade to (the default is the latest
                      version installed)</dd>

<dt>-p <i>clusterpath</i> </dt>    <dd> the new clusterpath (default = old clusterpath)</dd>

<dt>-d <i>dump directory</i></dt>   <dd>the directory in which to put the dump of the old
                      cluster (default = old clusterpath parent)</dd>

<dt>-r  </dt>                  <dd>recover; continue upgrading from a previous failure</dd>

</dl>
</p>
<p>Procedure:

<ol>
  <li>initdb a new cluster in <code><i>clusterpath</i>.new/data</code> for the new major
    version</li>

  <li>start a postmaster for the new cluster with port 5430</li>

  <li>stop the postmaster for the old cluster</li>

  <li>set the active field in <code>cluster_ports</code> to &quot;upgrading&quot;
</li>
  <li>start a postmaster for the old cluster with port 5431
</li>
  <li><code>pg_dumpall</code> the old cluster > <code><i>clustername</i>.dumpall</code></li>

  <li>load the dump in the new cluster > <code><i>dbname</i>.upgrade 2>&1</code></li>

  <li>if there are no errors, stop the two postmasters, else set status
    to "failed-upgrade" and exit
</li>
  <li>move the old cluster directory to <code><i>clusterpath</i>.old</code> and move
    <code><i>clusterpath</i>.new</code> to <code><i>clusterpath</i></code>; in <code>cluster_ports</code>, set the
    active field back to its original value
</li>
 <li>start the postmaster for the new cluster</li>
 
 <li>(with administrator approval only) delete the old cluster and
    the dump file</li>
</ol>
(All operations are done with the software version appropriate to the
cluster version.)
</p>


<h3>prerm script</h3>

<p>prerm should fail for any particular package postgresql-<i>ver</i> or
postgresql-client-<i>ver</i> if there is still a cluster for that version
listed in cluster_ports.  In other words, users have to upgrade or delete their databases
before they can remove the software package that is needed to read
those databases.</p>

<p><i><a href="mailto:pkg-postgresql-public@lists.alioth.debian.org">The Debian
PostgreSQL developers</a> (Oliver Elphick, Martin Pitt)</i></p>

</body>
</html>
